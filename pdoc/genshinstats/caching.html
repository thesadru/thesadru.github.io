<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>genshinstats.caching API documentation</title>
<meta name="description" content="Install a cache into genshinstats" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}#lunr-search{width:100%;font-size:1em;padding:6px 9px 5px 9px;border:1px solid silver}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>genshinstats.caching</code></h1>
</header>
<section id="section-intro">
<p>Install a cache into genshinstats</p>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/thesadru/genshinstats/blob/master/genshinstats/caching.py#L1-L204" class="git-link">Browse git</a>
</summary>
<pre><code class="python">&#34;&#34;&#34;Install a cache into genshinstats&#34;&#34;&#34;
import inspect
import os
import sys
from functools import update_wrapper
from itertools import islice
from typing import Any, Callable, Dict, List, MutableMapping, Tuple, TypeVar

import genshinstats as gs

__all__ = [&#34;permanent_cache&#34;, &#34;install_cache&#34;, &#34;uninstall_cache&#34;]

C = TypeVar(&#34;C&#34;, bound=Callable[..., Any])


def permanent_cache(*params: str) -&gt; Callable[[C], C]:
    &#34;&#34;&#34;Like lru_cache except permanent and only caches based on some parameters&#34;&#34;&#34;
    cache: Dict[Any, Any] = {}

    def wrapper(func):
        sig = inspect.signature(func)

        def inner(*args, **kwargs):
            bound = sig.bind(*args, **kwargs)
            bound.apply_defaults()
            # since the amount of arguments is constant we can just save the values
            key = tuple(v for k, v in bound.arguments.items() if k in params)

            if key in cache:
                return cache[key]
            r = func(*args, **kwargs)
            cache[key] = r
            return r

        inner.cache = cache
        return update_wrapper(inner, func)

    return wrapper  # type: ignore


def cache_func(func: C, cache: MutableMapping[Tuple[Any, ...], Any]) -&gt; C:
    &#34;&#34;&#34;Caches a normal function&#34;&#34;&#34;
    # prevent possible repeated cachings
    if hasattr(func, &#34;__cache__&#34;):
        return func

    sig = inspect.signature(func)

    def wrapper(*args, **kwargs):
        # create key (func name, *arguments)
        bound = sig.bind(*args, **kwargs)
        bound.apply_defaults()
        key = tuple(v for k, v in bound.arguments.items() if k != &#34;cookie&#34;)
        key = (func.__name__,) + key

        if key in cache:
            return cache[key]

        r = func(*args, **kwargs)
        cache[key] = r
        return r

    setattr(wrapper, &#34;__cache__&#34;, cache)
    setattr(wrapper, &#34;__original__&#34;, func)
    return update_wrapper(wrapper, func)  # type: ignore


def cache_paginator(func: C, cache: MutableMapping[Tuple[Any, ...], Any], strict: bool = False) -&gt; C:
    &#34;&#34;&#34;Caches an id generator such as wish history

    Respects size and authkey.
    If strict mode is on then the first item of the paginator will no longer be requested every time.
    &#34;&#34;&#34;
    if hasattr(func, &#34;__cache__&#34;):
        return func

    sig = inspect.signature(func)

    def wrapper(*args, **kwargs):
        # create key (transaction id, *arguments)
        # transaction ids are always unique no matter the function so this is safe
        # for heads (end_id=0) we either don&#39;t store them or store them as the function name
        bound = sig.bind(*args, **kwargs)
        bound.apply_defaults()
        arguments = bound.arguments

        # remove arguments that might cause problems
        size, authkey, end_id = [arguments.pop(k) for k in (&#34;size&#34;, &#34;authkey&#34;, &#34;end_id&#34;)]
        partial_key = tuple(arguments.values())

        # special recursive case must be ignored
        # otherwise an infinite recursion due to end_id resets will occur
        if &#34;banner_type&#34; in arguments and arguments[&#34;banner_type&#34;] is None:
            return func(*args, **kwargs)

        def helper(end_id: int):
            # in case we&#39;re using strict mode its fastest to just get the items at the start
            if end_id == 0 and strict:
                key = (func.__name__,) + partial_key
                while key in cache:
                    yield cache[key]
                    key = (cache[key][&#39;id&#39;],) + partial_key
            
            while True:
                # look ahead and add new items to the cache
                # since the size limit is always 20 we use that to make only a single request
                new = list(func(size=20, authkey=authkey, end_id=end_id, **arguments))
                if len(new) == 0:
                    break
                
                # we have to special-case end_id=0 since it&#39;s a bad idea to store the head by default
                if end_id != 0:
                    cache[(end_id,) + partial_key] = new[0]
                else:
                    yield new[0]
                    end_id = new[0][&#34;id&#34;]
                    if strict:
                        cache[(func.__name__,) + partial_key] = new[0]

                for p, n in zip(new, new[1:]):
                    cache[(p[&#34;id&#34;],) + partial_key] = n

                # yield new items
                key = (end_id,) + partial_key
                while key in cache:
                    yield cache[key]
                    key = (cache[key][&#39;id&#39;],) + partial_key

        return islice(helper(end_id), size)

    setattr(wrapper, &#34;__cache__&#34;, cache)
    setattr(wrapper, &#34;__original__&#34;, func)
    return update_wrapper(wrapper, func)  # type: ignore


def install_cache(cache: MutableMapping[Tuple[Any, ...], Any], strict: bool = False) -&gt; None:
    &#34;&#34;&#34;Installs a cache into every cacheable function in genshinstats

    If strict mode is on then the first item of the paginator will no longer be requested every time.
    That can however cause a variety of problems and it&#39;s therefore recommend to use it only with TTL caches.
    &#34;&#34;&#34;
    functions: List[Callable] = [
        # genshinstats
        gs.get_user_stats,
        gs.get_characters,
        gs.get_spiral_abyss,
        # wishes
        gs.get_banner_details,
        gs.get_gacha_items,
        # hoyolab
        gs.search,
        gs.get_record_card,
        gs.get_recommended_users,
    ]
    paginators: List[Callable] = [
        # wishes
        gs.get_wish_history,
        # transactions
        gs.get_artifact_log,
        gs.get_crystal_log,
        gs.get_primogem_log,
        gs.get_resin_log,
        gs.get_weapon_log,
    ]
    invalid: List[Callable] = [
        # normal generator
        gs.get_claimed_rewards,
        # cookie dependent
        gs.get_daily_reward_info,
        gs.get_game_accounts,
    ]

    wrapped = []
    for func in functions:
        wrapped.append(cache_func(func, cache))
    for func in paginators:
        wrapped.append(cache_paginator(func, cache, strict=strict))

    for func in wrapped:
        # ensure we only replace actual functions from the genshinstats directory
        for module in sys.modules.values():
            if not hasattr(module, func.__name__):
                continue
            orig_func = getattr(module, func.__name__)
            if (
                os.path.split(orig_func.__globals__[&#34;__file__&#34;])[0]
                != os.path.split(func.__globals__[&#34;__file__&#34;])[0] # type: ignore
            ):
                continue

            setattr(module, func.__name__, func)

def uninstall_cache() -&gt; None:
    &#34;&#34;&#34;Uninstalls the cache from all functions&#34;&#34;&#34;
    modules = sys.modules.copy()
    for module in modules.values():
        try:
            members = inspect.getmembers(module)
        except ModuleNotFoundError:
            continue
    
        for name, func in members:
            if hasattr(func, &#34;__cache__&#34;):
                setattr(module, name, getattr(func, &#34;__original__&#34;, func))</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="genshinstats.caching.install_cache"><code class="name flex">
<span>def <span class="ident">install_cache</span></span>(<span>cache: MutableMapping[Tuple[Any, ...], Any], strict: bool = False) ‑> None</span>
</code></dt>
<dd>
<div class="desc"><p>Installs a cache into every cacheable function in genshinstats</p>
<p>If strict mode is on then the first item of the paginator will no longer be requested every time.
That can however cause a variety of problems and it's therefore recommend to use it only with TTL caches.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/thesadru/genshinstats/blob/master/genshinstats/caching.py#L136-L191" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def install_cache(cache: MutableMapping[Tuple[Any, ...], Any], strict: bool = False) -&gt; None:
    &#34;&#34;&#34;Installs a cache into every cacheable function in genshinstats

    If strict mode is on then the first item of the paginator will no longer be requested every time.
    That can however cause a variety of problems and it&#39;s therefore recommend to use it only with TTL caches.
    &#34;&#34;&#34;
    functions: List[Callable] = [
        # genshinstats
        gs.get_user_stats,
        gs.get_characters,
        gs.get_spiral_abyss,
        # wishes
        gs.get_banner_details,
        gs.get_gacha_items,
        # hoyolab
        gs.search,
        gs.get_record_card,
        gs.get_recommended_users,
    ]
    paginators: List[Callable] = [
        # wishes
        gs.get_wish_history,
        # transactions
        gs.get_artifact_log,
        gs.get_crystal_log,
        gs.get_primogem_log,
        gs.get_resin_log,
        gs.get_weapon_log,
    ]
    invalid: List[Callable] = [
        # normal generator
        gs.get_claimed_rewards,
        # cookie dependent
        gs.get_daily_reward_info,
        gs.get_game_accounts,
    ]

    wrapped = []
    for func in functions:
        wrapped.append(cache_func(func, cache))
    for func in paginators:
        wrapped.append(cache_paginator(func, cache, strict=strict))

    for func in wrapped:
        # ensure we only replace actual functions from the genshinstats directory
        for module in sys.modules.values():
            if not hasattr(module, func.__name__):
                continue
            orig_func = getattr(module, func.__name__)
            if (
                os.path.split(orig_func.__globals__[&#34;__file__&#34;])[0]
                != os.path.split(func.__globals__[&#34;__file__&#34;])[0] # type: ignore
            ):
                continue

            setattr(module, func.__name__, func)</code></pre>
</details>
</dd>
<dt id="genshinstats.caching.permanent_cache"><code class="name flex">
<span>def <span class="ident">permanent_cache</span></span>(<span>*params: str) ‑> Callable[[~C], ~C]</span>
</code></dt>
<dd>
<div class="desc"><p>Like lru_cache except permanent and only caches based on some parameters</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/thesadru/genshinstats/blob/master/genshinstats/caching.py#L16-L38" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def permanent_cache(*params: str) -&gt; Callable[[C], C]:
    &#34;&#34;&#34;Like lru_cache except permanent and only caches based on some parameters&#34;&#34;&#34;
    cache: Dict[Any, Any] = {}

    def wrapper(func):
        sig = inspect.signature(func)

        def inner(*args, **kwargs):
            bound = sig.bind(*args, **kwargs)
            bound.apply_defaults()
            # since the amount of arguments is constant we can just save the values
            key = tuple(v for k, v in bound.arguments.items() if k in params)

            if key in cache:
                return cache[key]
            r = func(*args, **kwargs)
            cache[key] = r
            return r

        inner.cache = cache
        return update_wrapper(inner, func)

    return wrapper  # type: ignore</code></pre>
</details>
</dd>
<dt id="genshinstats.caching.uninstall_cache"><code class="name flex">
<span>def <span class="ident">uninstall_cache</span></span>(<span>) ‑> None</span>
</code></dt>
<dd>
<div class="desc"><p>Uninstalls the cache from all functions</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/thesadru/genshinstats/blob/master/genshinstats/caching.py#L193-L204" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def uninstall_cache() -&gt; None:
    &#34;&#34;&#34;Uninstalls the cache from all functions&#34;&#34;&#34;
    modules = sys.modules.copy()
    for module in modules.values():
        try:
            members = inspect.getmembers(module)
        except ModuleNotFoundError:
            continue
    
        for name, func in members:
            if hasattr(func, &#34;__cache__&#34;):
                setattr(module, name, getattr(func, &#34;__original__&#34;, func))</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<form>
<input id="lunr-search" name="q" placeholder="🔎 Search ..." aria-label="Search"
disabled minlength="2">
</form>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/tingle/0.15.3/tingle.min.css" integrity="sha512-j1u8eUJ4f23xPPxwOrLUPQaCD2dwzNqqmDDcWS4deWsMv2ohLqmXXuP3hU7g8TyzbMSakP/mMqoNBYWj8AEIFg==" crossorigin>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tingle/0.15.3/tingle.min.js" integrity="sha512-plGUER9JkeEWPPqQBE4sdLqBoQug5Ap+BCGMc7bJ8BXkm+VVj6QzkpBz5Yv2yPkkq+cqg9IpkBaGCas6uDbW8g==" crossorigin></script>
<style>
.modal-dialog iframe {
width: 100vw;
height: calc(100vh - 80px);
}
@media screen and (min-width: 700px) {
.modal-dialog iframe {
width: 70vw;
height: 80vh;
}
}
.modal-dialog .tingle-modal-box {width: auto;}
.modal-dialog .tingle-modal-box__content {padding: 0;}
</style>
<script>
const input = document.getElementById('lunr-search');
input.disabled = false;
input.form.addEventListener('submit', (ev) => {
ev.preventDefault();
const url = new URL(window.location);
url.searchParams.set('q', input.value);
history.replaceState({}, null, url.toString());
search(input.value);
});
const query = new URL(window.location).searchParams.get('q');
if (query)
search(query);
function search(query) {
const url = '../doc-search.html#' + encodeURIComponent(query);
new tingle.modal({
cssClass: ['modal-dialog'],
onClose: () => {
const url = new URL(window.location);
url.searchParams.delete('q');
history.replaceState({}, null, url.toString());
setTimeout(() => input.focus(), 100);
}
}).setContent('<iframe src="' + url + '"></iframe>').open();
}
</script>
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="genshinstats" href="index.html">genshinstats</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="genshinstats.caching.install_cache" href="#genshinstats.caching.install_cache">install_cache</a></code></li>
<li><code><a title="genshinstats.caching.permanent_cache" href="#genshinstats.caching.permanent_cache">permanent_cache</a></code></li>
<li><code><a title="genshinstats.caching.uninstall_cache" href="#genshinstats.caching.uninstall_cache">uninstall_cache</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>